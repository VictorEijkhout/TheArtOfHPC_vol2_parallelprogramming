% -*- latex -*-
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%
%%%% This LaTeX file is part of the source of 
%%%% `Parallel Computing'
%%%% by Victor Eijkhout, copyright 2012-2024
%%%%
%%%% idxpkgmacs.tex : index-related macros for specific packages
%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%
%%%% define the indexes
%%%%
\makeindex[name=mpi,title=,columns=1]
\makeindex[name=mpl,title=,columns=1]
\makeindex[name=omp,title=,columns=1]
\makeindex[name=petsc,title=,columns=1]
\makeindex[name=kokkos,title=,columns=1]
\makeindex[name=sycl,title=,columns=1]
\makeindex[name=python,title=,columns=1]

%%%%
%%%% Index routines for various packages
%%%%

%% mpi
\newcommand\indexmpishow{\PackageIndex\mpiIndexRM}
\newcommand\indexmpidepr{\PackageIndex\mpiIndexRd}
\newcommand\indexmpidef {\PackageIndex\mpiIndexBF}
\newcommand\indexmpiex  {\PackageIndex\mpiIndexIT}
% versions that generate man page
\newcommand\indexmpiref {\PackageIndex   \mpiIndexAndRef}
\newcommand\indexmpixref{\PackageIndexTwo\mpiIndexAndXRef}
\let\indexmpirep\indexmpishow % need to incorporate link to man page

\newcommand\mpiIndexBF{\RoutineIndexFont{mpi}{textbf}\endgroup}
\newcommand\mpiIndexRM{\RoutineIndexFont{mpi}{textrm}\endgroup}
\newcommand\mpiIndexRd{\RoutineDeprcFont{mpi}{textrm}\endgroup}
\newcommand\mpiIndexIT{\RoutineIndexFont{mpi}{textsl}\endgroup}
\newcommand\mpiIndexAndRef{% this is called through afterassignment; \indexedroutine has been set
  \global\let\referencedroutine\indexedroutine
  \RoutineShowAndIndex{mpi}{textbf}% show name, index, reference to figure
  \endgroup % end of innocent characters
  \def\routinefam{mpi}\RoutineRefDisplay
}
\newcommand\mpiIndexAndXRef{%
  \RoutineShowAndIndex{mpi}{textbf}%
  \endgroup}

%% mpi stuff to be cleaned up
{ \catcode`\_=13
  \gdef\indexmpishowf#{\bgroup
    \InnocentChars \def\\{\char`\\}\relax
    \ShowRoutinetrue
    \afterassignment\mpitoindexf\edef\indexedmpi}
  \gdef\indexmpishowp#{\bgroup
    \InnocentChars \def\\{\char`\\}\relax
    \ShowRoutinetrue
    \afterassignment\mpitoindexp\edef\indexedmpi}
  \gdef\indexmpishowsub#{\bgroup
    \InnocentChars
    \catcode`\_=13 \def_{\char95\discretionary{}{}{}}
    \def\\{\char`\\}\relax
    %
    \tt \afterassignment\defineindexmpisubtwo \xdef\indexedmpisubone}
  \gdef\defineindexmpisubtwo{\afterassignment\mpitoindexsub \gdef\indexedmpisubtwo}
}

% mpl
\newcommand\indexmplshow{\PackageIndex\mplIndexRM}
\newcommand\indexmpldef {\PackageIndex\mplIndexBF}
\newcommand\indexmplref {\PackageIndex\mplIndexAndRef}
\newcommand\indexmplex  {\PackageIndex\mplIndexIT}
\let\indexmplrep\indexmplshow % need to incorporate link to man page

\newcommand\mplIndexBF{\RoutineIndexFont{mpl}{textbf}\endgroup}
\newcommand\mplIndexRM{\RoutineIndexFont{mpl}{textrm}\endgroup}
\newcommand\mplIndexIT{\RoutineIndexFont{mpl}{textsl}\endgroup}
\newcommand\mplIndexAndRef{%
  \let\referencedroutine\indexedroutine
  \RoutineShowAndIndex{mpl}{textbf}%
  \def\routinefam{mpl}\RoutineRefDisplay\endgroup}

% omp
\newcommand\indexompterm  {\PackageIndex\ompIndexTe}
\newcommand\indexompshow  {\PackageIndex\ompIndexRM}
\newcommand\indexompdepr  {\PackageIndex\ompIndexRd}
\newcommand\indexompdef   {\PackageIndex\ompIndexBF}
\newcommand\indexompclause{\PackageIndex\ompIndexRM}
\newcommand\indexompref   {\PackageIndex\ompIndexAndRef}
\newcommand\indexompex    {\PackageIndex\ompIndexIT}
\let\indexomprep\indexompshow % need to incorporate link to man page

\newcommand\indexomppragma   {\PackageIndex\ompIndexTT}
\newcommand\indexomppragmadef{\PackageIndex\ompIndexBF}
\index[omp]{pragma|see{see under pragma name}}
\newcommand\indexclause   {\PackageIndex\ompIndexTT}
\newcommand\indexclausedef{\PackageIndex\ompIndexTT}
\def\indexclauseoption#1#2{\texttt{#2}\index[omp]{#1!#2}}
\def\indexompclauseoption#1#2{\texttt{#2}\index[omp]{#1!#2}}

\newcommand\ompIndexTe{\TermIndexFont{omp}{textrm}\endgroup}
\newcommand\ompIndexTT{\RoutineIndexFont{omp}{texttt}\endgroup}
\newcommand\ompIndexRM{\RoutineIndexFont{omp}{textrm}\endgroup}
\newcommand\ompIndexBF{\RoutineIndexFont{omp}{textbf}\endgroup}
\newcommand\ompIndexRd{\RoutineDeprcFont{omp}{textrm}\endgroup}
\newcommand\ompIndexIT{\RoutineIndexFont{omp}{textsl}\endgroup}
\newcommand\ompIndexAndRef{%
  \let\referencedroutine\indexedroutine
  \RoutineIndexFont{omp}{textbf}%
  \def\routinefam{omp}\RoutineRefDisplay\endgroup}

% petsc
\newcommand\indexpetscshow{\PackageIndex\petscIndexRM}
\newcommand\indexpetscdepr{\PackageIndex\petscIndexRd}
\newcommand\indexpetscdef {\PackageIndex\petscIndexBF}
\newcommand\indexpetscref {\PackageIndex\petscIndexAndRef}
\newcommand\indexpetscex  {\PackageIndex\petscIndexIT}
\newcommand\indexpetsctt  {\PackageIndex\petscIndexTT}
\newcommand\indexpetscfile{\PackageIndex\petscIndexTT}
\let\indexpetscrep\indexpetscshow % need to incorporate link to man page

\newcommand\petscIndexBF{\RoutineIndexFont{petsc}{textbf}\endgroup}
\newcommand\petscIndexRM{\RoutineIndexFont{petsc}{textrm}\endgroup}
\newcommand\petscIndexRd{\RoutineDeprcFont{petsc}{textrm}\endgroup}
\newcommand\petscIndexIT{\RoutineIndexFont{petsc}{textsl}\endgroup}
\newcommand\petscIndexTT{\RoutineIndexFont{petsc}{texttt}\endgroup}
\newcommand\petscIndexAndRef{%
  \let\referencedroutine\indexedroutine
  \RoutineShowAndIndex{petsc}{textbf}%
  \def\routinefam{petsc}\RoutineRefDisplay\endgroup}

\def\indexpetscxref#1#2{\def\indexedroutine{#1}\def\displayedroutine{#2}%
  %\petscIndexBF -> \RoutineIndexBF{petsc}
  \edef\tmp{%
    \noexpand\lstinline+\indexedroutine+
    (figure\noexpand~\noexpand\ref{ref:\displayedroutine})%
    \noexpand\index[petsc]{%
      \indexedroutine@{\catcode95=12 \noexpand\texttt{\indexedroutine}}|textbf}%
  }%
  \tmp
}  

% sycl
\newcommand\indexsyclshow{\PackageIndex\syclIndexRM}
\newcommand\indexsycldef {\PackageIndex\syclIndexBF}
\newcommand\syclIndexBF{\RoutineIndexFont{sycl}{textbf}\endgroup}
\newcommand\syclIndexRM{\RoutineIndexFont{sycl}{textrm}\endgroup}

% kokkos
\newcommand\indexkokkosshow{\PackageIndex\kokkosIndexRM}
\let\indexkokkos\indexkokkosshow
\newcommand\indexkokkosdef {\PackageIndex\kokkosIndexBF}
\newcommand\kokkosIndexBF{\RoutineIndexFont{kokkos}{textbf}\endgroup}
\newcommand\kokkosIndexRM{\RoutineIndexFont{kokkos}{textrm}\endgroup}

%%%%
%%%% Basic routines for all the above
%%%%

%%
%% Define `indexedroutine' and invoke #1 which will process this
%%
\newif\ifShowRoutine
\newcommand\PackageIndex[1]{\begingroup
    \InnocentChars \ShowRoutinetrue
    \afterassignment#1\xdef\indexedroutine
}

%%
%% Define `indexedroutine' and `referencedroutine' and invoke #1 which will process this
%%
\newcommand\PackageIndexTwo[1]{\begingroup
    \InnocentChars \ShowRoutinetrue
    \let\routineprocess=#1%
    \afterassignment\defineReferencedAndProcess
    \edef\indexedroutine
}
\newcommand\defineReferencedAndProcess{%
  \afterassignment\routineprocess
  \edef\referencedroutine}

%%
%% Write `indexedroutine' to index #1 with #2 font
%%
\newcommand\RoutineIndexFont[2]{% 
  \def\ifont{#2}\def\bfont{textbf}%
  \edef\tmp{%
    %%\noexpand\lstinline[language=#1]+\indexedroutine+%
    \noexpand\lstinline+\indexedroutine+%
    \ifx\ifont\bfont\noexpand\label{def:\indexedroutine}\fi%
    \noexpand\index[#1]{%
      \indexedroutine@{\catcode95=12 \noexpand\texttt{\indexedroutine}}|#2}%
  }%
  \tmp%
}
\def\TermIndexFont#1#2{% 
  \def\ifont{#2}\def\bfont{textbf}%
  \edef\tmp{%
    \noexpand\textsl{\indexedroutine}%
    \ifx\ifont\bfont\noexpand\label{def:\indexedroutine}\fi%
    \noexpand\index[#1]{\indexedroutine|#2}%
    \noexpand\index{\indexedroutine (OpenMP)}%
  }%
  \tmp
}
\def\RoutineDeprcFont#1#2{% 
  \edef\tmp{%
    \noexpand\lstinline+\indexedroutine+%
    \noexpand\index[#1]{%
      \indexedroutine@{\catcode95=12 \noexpand\texttt{\indexedroutine} (deprecated)}|#2}%
  }%
  \tmp
}
